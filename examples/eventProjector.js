"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const Highland = require("highland");
const index_1 = require("../build/index");
const kafka_1 = require("../build/kafka");
const projector_1 = require("../build/projector");
const pubsub_1 = require("../build/pubsub");
const index_2 = require("./index");
const localDockerConnectorRedis_1 = require("./localDockerConnectorRedis");
var DML_OPERATION;
(function (DML_OPERATION) {
    DML_OPERATION[DML_OPERATION["CREATE"] = 0] = "CREATE";
    DML_OPERATION[DML_OPERATION["UPDATE"] = 1] = "UPDATE";
    DML_OPERATION[DML_OPERATION["DELETE"] = 2] = "DELETE";
})(DML_OPERATION || (DML_OPERATION = {}));
// Build list of changes
const changes = [
    {
        data: {
            copy_english__c: "test",
            copy_french__c: "toto",
            id: "1",
            merchant__c: "123",
            name: "a",
        },
        operation: DML_OPERATION.CREATE,
    },
    {
        data: {
            copy_english__c: "test",
            copy_french__c: "toto",
            id: "2",
            merchant__c: "123",
            name: "b",
        },
        operation: DML_OPERATION.CREATE,
    },
    {
        data: {
            copy_english__c: "test",
            copy_french__c: "toto",
            id: "3",
            merchant__c: "124",
            name: "c",
        },
        operation: DML_OPERATION.CREATE,
    },
];
function changeToEvent(change) {
    const data = change.data;
    return new index_2.OfferCreateEvent(data.id, data.merchant__c, data.name, data.copy_english__c, data.copy_french__c);
}
const inputTopic = "inputTest";
const projectedTopic = "projectedTest";
const kvStore = new localDockerConnectorRedis_1.KVStore();
const publisherClientId = "test.publisher";
const metadataWriter = index_1.buildMetadataWriter(publisherClientId);
const consumerClientId = "test.consumer";
const consumerGroupId = "test.consumer.group";
const subscriber = kafka_1.buildSubscriber("kafka:9092", consumerClientId, consumerGroupId);
const testConsumerClientId = "test.consumer";
const testConsumerGroupId = "test.consumer.group.test";
const testSubscriber = kafka_1.buildSubscriber("kafka:9092", testConsumerClientId, testConsumerGroupId);
kafka_1.buildPublisher("kafka:9092", publisherClientId)
    .then((publisher) => {
    const inputXform = pubsub_1.buildPublishingTransform(publisher, inputTopic, metadataWriter, new index_2.OfferCreateEventSerde(publisherClientId));
    const inboundStream = pubsub_1.buildSubscriptionStream(subscriber, [inputTopic], new index_2.OfferCreateEventSerde(consumerClientId));
    const projectedXform = pubsub_1.buildPublishingTransform(publisher, projectedTopic, metadataWriter, new index_2.OfferSetEventtSerde(publisherClientId));
    const consumingStream = pubsub_1.buildSubscriptionStream(testSubscriber, [projectedTopic], new index_2.OfferSetEventtSerde(testConsumerClientId));
    Highland(changes)
        .map(changeToEvent)
        .map(inputXform)
        .each((result) => result.successful ? console.info(`Published message to ${inputTopic}`) : console.error("Couldn't publish error", result.error))
        .done(() => {
        console.log("Finished producing on input topic");
    });
    const eventKeyFn = (event) => event.id;
    const getStateFn = projector_1.buildGetStateFn(kvStore, eventKeyFn);
    const setStateFn = projector_1.buildSetStateFn(kvStore, eventKeyFn);
    const reduceFn = ([event, currentState]) => {
        const newState = {
            copyEnglish: event.copyEnglish,
            copyFrench: event.copyFrench,
            id: event.id,
            merchantId: event.merchantId,
            name: event.name,
        };
        return [event, currentState, newState];
    };
    inboundStream
        .errors((err) => console.error("Projector consumer error", err))
        .map((del) => del.event)
        .map((e) => Highland(getStateFn(e)))
        .sequence()
        .map(reduceFn)
        .map((input) => Highland(setStateFn(input)))
        .sequence()
        .map(([event, oldState, newState]) => new index_2.OfferSetEvent(newState.id, newState.merchantId, newState.name, newState.copyEnglish, newState.copyFrench))
        .map(projectedXform)
        .each((result) => result.successful ? console.info(`Published message to ${projectedTopic}`) : console.error("Couldn't publish error", result.error))
        .done(() => console.log("Finished consuming on input topic"));
    consumingStream
        .map((del) => del.event)
        .each((event) => console.info("Received event", event))
        .done(() => console.log("Finished consuming on projected topic."));
});

//# sourceMappingURL=data:application/json;charset=utf8;base64,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QyxDQUFDO1NBQ3BLLElBQUksQ0FBQyxHQUFHLEVBQUUsQ0FBQyxPQUFPLENBQUMsR0FBRyxDQUFDLG1DQUFtQyxDQUFDLENBQUMsQ0FBQztJQUNsRSxlQUFlO1NBQ1YsR0FBRyxDQUFnQixDQUFDLEdBQTZCLEVBQU8sRUFBRSxDQUFDLEdBQUcsQ0FBQyxLQUFLLENBQUM7U0FDckUsSUFBSSxDQUFDLENBQUMsS0FBb0IsRUFBRSxFQUFFLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxnQkFBZ0IsRUFBRSxLQUFLLENBQUMsQ0FBQztTQUNyRSxJQUFJLENBQUMsR0FBRyxFQUFFLENBQUMsT0FBTyxDQUFDLEdBQUcsQ0FBQyx3Q0FBd0MsQ0FBQyxDQUFDLENBQUM7QUFDM0UsQ0FBQyxDQUFDLENBQUMiLCJmaWxlIjoiZXhhbXBsZXMvZXZlbnRQcm9qZWN0b3IuanMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgKiBhcyBIaWdobGFuZCBmcm9tIFwiaGlnaGxhbmRcIjtcbmltcG9ydCB7IGJ1aWxkTWV0YWRhdGFXcml0ZXIsIEV2ZW50LCBJRGVsaXZlcnksIElQdWJsaXNoZXIsIElQdWJsaXNoUmVzdWx0IH0gZnJvbSBcIi4uL2J1aWxkL2luZGV4XCI7XG5pbXBvcnQgeyBidWlsZFB1Ymxpc2hlciwgYnVpbGRTdWJzY3JpYmVyIH0gZnJvbSBcIi4uL2J1aWxkL2thZmthXCI7XG5pbXBvcnQgeyBidWlsZEdldFN0YXRlRm4sIGJ1aWxkU2V0U3RhdGVGbiwgR2V0UmVzdWx0LCBSZWR1Y2VGbiwgUmVkdWNlUmVzdWx0LCBTZXRSZXN1bHQgfSBmcm9tIFwiLi4vYnVpbGQvcHJvamVjdG9yXCI7XG5pbXBvcnQgeyBidWlsZFB1Ymxpc2hpbmdUcmFuc2Zvcm0sIGJ1aWxkU3Vic2NyaXB0aW9uU3RyZWFtIH0gZnJvbSBcIi4uL2J1aWxkL3B1YnN1YlwiO1xuaW1wb3J0IHsgT2ZmZXJDcmVhdGVFdmVudCwgT2ZmZXJDcmVhdGVFdmVudFNlcmRlLCBPZmZlclNldEV2ZW50LCBPZmZlclNldEV2ZW50dFNlcmRlIH0gZnJvbSBcIi4vaW5kZXhcIjtcbmltcG9ydCB7IEtWU3RvcmUgfSBmcm9tIFwiLi9sb2NhbERvY2tlckNvbm5lY3RvclJlZGlzXCI7XG5cbmVudW0gRE1MX09QRVJBVElPTiB7XG4gICAgQ1JFQVRFLFxuICAgIFVQREFURSxcbiAgICBERUxFVEUsXG59XG5cbmludGVyZmFjZSBJT2ZmZXJSZWNvcmQge1xuICAgIGlkOiBzdHJpbmc7XG4gICAgbWVyY2hhbnRfX2M6IHN0cmluZztcbiAgICBuYW1lOiBzdHJpbmc7XG4gICAgY29weV9lbmdsaXNoX19jOiBzdHJpbmc7XG4gICAgY29weV9mcmVuY2hfX2M6IHN0cmluZztcbn1cblxuaW50ZXJmYWNlIElEYXRhQ2hhbmdlIHtcbiAgICBvcGVyYXRpb246IERNTF9PUEVSQVRJT047XG4gICAgZGF0YTogb2JqZWN0O1xufVxuXG4vLyBCdWlsZCBsaXN0IG9mIGNoYW5nZXNcbmNvbnN0IGNoYW5nZXMgPSBbXG4gICAge1xuICAgICAgICBkYXRhOiB7XG4gICAgICAgICAgICBjb3B5X2VuZ2xpc2hfX2M6IFwidGVzdFwiLFxuICAgICAgICAgICAgY29weV9mcmVuY2hfX2M6IFwidG90b1wiLFxuICAgICAgICAgICAgaWQ6IFwiMVwiLFxuICAgICAgICAgICAgbWVyY2hhbnRfX2M6IFwiMTIzXCIsXG4gICAgICAgICAgICBuYW1lOiBcImFcIixcbiAgICAgICAgfSxcbiAgICAgICAgb3BlcmF0aW9uOiBETUxfT1BFUkFUSU9OLkNSRUFURSxcbiAgICB9LFxuICAgIHtcbiAgICAgICAgZGF0YToge1xuICAgICAgICAgICAgY29weV9lbmdsaXNoX19jOiBcInRlc3RcIixcbiAgICAgICAgICAgIGNvcHlfZnJlbmNoX19jOiBcInRvdG9cIixcbiAgICAgICAgICAgIGlkOiBcIjJcIixcbiAgICAgICAgICAgIG1lcmNoYW50X19jOiBcIjEyM1wiLFxuICAgICAgICAgICAgbmFtZTogXCJiXCIsXG4gICAgICAgIH0sXG4gICAgICAgIG9wZXJhdGlvbjogRE1MX09QRVJBVElPTi5DUkVBVEUsXG4gICAgfSxcbiAgICB7XG4gICAgICAgIGRhdGE6IHtcbiAgICAgICAgICAgIGNvcHlfZW5nbGlzaF9fYzogXCJ0ZXN0XCIsXG4gICAgICAgICAgICBjb3B5X2ZyZW5jaF9fYzogXCJ0b3RvXCIsXG4gICAgICAgICAgICBpZDogXCIzXCIsXG4gICAgICAgICAgICBtZXJjaGFudF9fYzogXCIxMjRcIixcbiAgICAgICAgICAgIG5hbWU6IFwiY1wiLFxuICAgICAgICB9LFxuICAgICAgICBvcGVyYXRpb246IERNTF9PUEVSQVRJT04uQ1JFQVRFLFxuICAgIH0sXG5dO1xuXG5mdW5jdGlvbiBjaGFuZ2VUb0V2ZW50KGNoYW5nZTogSURhdGFDaGFuZ2UpOiBPZmZlckNyZWF0ZUV2ZW50IHtcbiAgICBjb25zdCBkYXRhOiBJT2ZmZXJSZWNvcmQgPSBjaGFuZ2UuZGF0YSBhcyBJT2ZmZXJSZWNvcmQ7XG4gICAgcmV0dXJuIG5ldyBPZmZlckNyZWF0ZUV2ZW50KGRhdGEuaWQsIGRhdGEubWVyY2hhbnRfX2MsIGRhdGEubmFtZSwgZGF0YS5jb3B5X2VuZ2xpc2hfX2MsIGRhdGEuY29weV9mcmVuY2hfX2MpO1xufVxuXG5jb25zdCBpbnB1dFRvcGljID0gXCJpbnB1dFRlc3RcIjtcbmNvbnN0IHByb2plY3RlZFRvcGljID0gXCJwcm9qZWN0ZWRUZXN0XCI7XG5jb25zdCBrdlN0b3JlID0gbmV3IEtWU3RvcmUoKTtcbmNvbnN0IHB1Ymxpc2hlckNsaWVudElkID0gXCJ0ZXN0LnB1Ymxpc2hlclwiO1xuY29uc3QgbWV0YWRhdGFXcml0ZXIgPSBidWlsZE1ldGFkYXRhV3JpdGVyKHB1Ymxpc2hlckNsaWVudElkKTtcblxuY29uc3QgY29uc3VtZXJDbGllbnRJZCA9IFwidGVzdC5jb25zdW1lclwiO1xuY29uc3QgY29uc3VtZXJHcm91cElkID0gXCJ0ZXN0LmNvbnN1bWVyLmdyb3VwXCI7XG5jb25zdCBzdWJzY3JpYmVyID0gYnVpbGRTdWJzY3JpYmVyKFwia2Fma2E6OTA5MlwiLCBjb25zdW1lckNsaWVudElkLCBjb25zdW1lckdyb3VwSWQpO1xuY29uc3QgdGVzdENvbnN1bWVyQ2xpZW50SWQgPSBcInRlc3QuY29uc3VtZXJcIjtcbmNvbnN0IHRlc3RDb25zdW1lckdyb3VwSWQgPSBcInRlc3QuY29uc3VtZXIuZ3JvdXAudGVzdFwiO1xuY29uc3QgdGVzdFN1YnNjcmliZXIgPSBidWlsZFN1YnNjcmliZXIoXCJrYWZrYTo5MDkyXCIsIHRlc3RDb25zdW1lckNsaWVudElkLCB0ZXN0Q29uc3VtZXJHcm91cElkKTtcblxuYnVpbGRQdWJsaXNoZXIoXCJrYWZrYTo5MDkyXCIsIHB1Ymxpc2hlckNsaWVudElkKVxuICAgIC50aGVuKChwdWJsaXNoZXI6IElQdWJsaXNoZXIpID0+IHtcbiAgICAgICAgY29uc3QgaW5wdXRYZm9ybSA9IGJ1aWxkUHVibGlzaGluZ1RyYW5zZm9ybShwdWJsaXNoZXIsIGlucHV0VG9waWMsIG1ldGFkYXRhV3JpdGVyLCBuZXcgT2ZmZXJDcmVhdGVFdmVudFNlcmRlKHB1Ymxpc2hlckNsaWVudElkKSk7XG4gICAgICAgIGNvbnN0IGluYm91bmRTdHJlYW0gPSBidWlsZFN1YnNjcmlwdGlvblN0cmVhbShzdWJzY3JpYmVyLCBbaW5wdXRUb3BpY10sIG5ldyBPZmZlckNyZWF0ZUV2ZW50U2VyZGUoY29uc3VtZXJDbGllbnRJZCkpO1xuICAgICAgICBjb25zdCBwcm9qZWN0ZWRYZm9ybSA9IGJ1aWxkUHVibGlzaGluZ1RyYW5zZm9ybShwdWJsaXNoZXIsIHByb2plY3RlZFRvcGljLCBtZXRhZGF0YVdyaXRlciwgbmV3IE9mZmVyU2V0RXZlbnR0U2VyZGUocHVibGlzaGVyQ2xpZW50SWQpKTtcbiAgICAgICAgY29uc3QgY29uc3VtaW5nU3RyZWFtID0gYnVpbGRTdWJzY3JpcHRpb25TdHJlYW0odGVzdFN1YnNjcmliZXIsIFtwcm9qZWN0ZWRUb3BpY10sIG5ldyBPZmZlclNldEV2ZW50dFNlcmRlKHRlc3RDb25zdW1lckNsaWVudElkKSk7XG4gICAgICAgIEhpZ2hsYW5kKGNoYW5nZXMpXG4gICAgICAgICAgICAubWFwPE9mZmVyQ3JlYXRlRXZlbnQ+KGNoYW5nZVRvRXZlbnQpXG4gICAgICAgICAgICAubWFwPElQdWJsaXNoUmVzdWx0PihpbnB1dFhmb3JtKVxuICAgICAgICAgICAgLmVhY2goKHJlc3VsdDogSVB1Ymxpc2hSZXN1bHQpID0+IHJlc3VsdC5zdWNjZXNzZnVsID8gY29uc29sZS5pbmZvKGBQdWJsaXNoZWQgbWVzc2FnZSB0byAke2lucHV0VG9waWN9YCkgOiBjb25zb2xlLmVycm9yKFwiQ291bGRuJ3QgcHVibGlzaCBlcnJvclwiLCByZXN1bHQuZXJyb3IpKVxuICAgICAgICAgICAgLmRvbmUoKCkgPT4ge1xuICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKFwiRmluaXNoZWQgcHJvZHVjaW5nIG9uIGlucHV0IHRvcGljXCIpO1xuICAgICAgICAgICAgfSk7XG4gICAgICAgIGNvbnN0IGV2ZW50S2V5Rm4gPSAoZXZlbnQ6IE9mZmVyQ3JlYXRlRXZlbnQpOiBzdHJpbmcgPT4gZXZlbnQuaWQ7XG4gICAgICAgIGNvbnN0IGdldFN0YXRlRm4gPSBidWlsZEdldFN0YXRlRm4oa3ZTdG9yZSwgZXZlbnRLZXlGbik7XG4gICAgICAgIGNvbnN0IHNldFN0YXRlRm4gPSBidWlsZFNldFN0YXRlRm4oa3ZTdG9yZSwgZXZlbnRLZXlGbik7XG4gICAgICAgIGNvbnN0IHJlZHVjZUZuID0gKFtldmVudCwgY3VycmVudFN0YXRlXTogW09mZmVyQ3JlYXRlRXZlbnQsIGFueSB8IGFueV0pOiBbT2ZmZXJDcmVhdGVFdmVudCwgYW55LCBhbnldIHwgRXJyb3IgPT4ge1xuICAgICAgICAgICAgY29uc3QgbmV3U3RhdGUgPSB7XG4gICAgICAgICAgICAgICAgY29weUVuZ2xpc2g6IGV2ZW50LmNvcHlFbmdsaXNoLFxuICAgICAgICAgICAgICAgIGNvcHlGcmVuY2g6IGV2ZW50LmNvcHlGcmVuY2gsXG4gICAgICAgICAgICAgICAgaWQ6IGV2ZW50LmlkLFxuICAgICAgICAgICAgICAgIG1lcmNoYW50SWQ6IGV2ZW50Lm1lcmNoYW50SWQsXG4gICAgICAgICAgICAgICAgbmFtZTogZXZlbnQubmFtZSxcbiAgICAgICAgICAgIH07XG4gICAgICAgICAgICByZXR1cm4gW2V2ZW50LCBjdXJyZW50U3RhdGUsIG5ld1N0YXRlXTtcbiAgICAgICAgfTtcbiAgICAgICAgaW5ib3VuZFN0cmVhbVxuICAgICAgICAgICAgLmVycm9ycygoZXJyOiBFcnJvcikgPT4gY29uc29sZS5lcnJvcihcIlByb2plY3RvciBjb25zdW1lciBlcnJvclwiLCBlcnIpKVxuICAgICAgICAgICAgLm1hcDxPZmZlckNyZWF0ZUV2ZW50PigoZGVsOiBJRGVsaXZlcnk8T2ZmZXJDcmVhdGVFdmVudD4pOiBhbnkgPT4gZGVsLmV2ZW50KVxuICAgICAgICAgICAgLm1hcDxIaWdobGFuZC5TdHJlYW08R2V0UmVzdWx0IHwgRXJyb3I+PigoZTogRXZlbnQpID0+IEhpZ2hsYW5kKGdldFN0YXRlRm4oZSkpKVxuICAgICAgICAgICAgLnNlcXVlbmNlKClcbiAgICAgICAgICAgIC5tYXA8UmVkdWNlUmVzdWx0IHwgRXJyb3I+KHJlZHVjZUZuKVxuICAgICAgICAgICAgLm1hcDxIaWdobGFuZC5TdHJlYW08U2V0UmVzdWx0IHwgRXJyb3I+PigoaW5wdXQ6IFJlZHVjZVJlc3VsdCkgPT4gSGlnaGxhbmQoc2V0U3RhdGVGbihpbnB1dCkpKVxuICAgICAgICAgICAgLnNlcXVlbmNlKClcbiAgICAgICAgICAgIC5tYXA8T2ZmZXJTZXRFdmVudD4oKFtldmVudCwgb2xkU3RhdGUsIG5ld1N0YXRlXTogU2V0UmVzdWx0KSA9PiBuZXcgT2ZmZXJTZXRFdmVudChuZXdTdGF0ZS5pZCwgbmV3U3RhdGUubWVyY2hhbnRJZCwgbmV3U3RhdGUubmFtZSwgbmV3U3RhdGUuY29weUVuZ2xpc2gsIG5ld1N0YXRlLmNvcHlGcmVuY2gpKVxuICAgICAgICAgICAgLm1hcDxJUHVibGlzaFJlc3VsdD4ocHJvamVjdGVkWGZvcm0pXG4gICAgICAgICAgICAuZWFjaCgocmVzdWx0OiBJUHVibGlzaFJlc3VsdCkgPT4gcmVzdWx0LnN1Y2Nlc3NmdWwgPyBjb25zb2xlLmluZm8oYFB1Ymxpc2hlZCBtZXNzYWdlIHRvICR7cHJvamVjdGVkVG9waWN9YCkgOiBjb25zb2xlLmVycm9yKFwiQ291bGRuJ3QgcHVibGlzaCBlcnJvclwiLCByZXN1bHQuZXJyb3IpKVxuICAgICAgICAgICAgLmRvbmUoKCkgPT4gY29uc29sZS5sb2coXCJGaW5pc2hlZCBjb25zdW1pbmcgb24gaW5wdXQgdG9waWNcIikpO1xuICAgICAgICBjb25zdW1pbmdTdHJlYW1cbiAgICAgICAgICAgIC5tYXA8T2ZmZXJTZXRFdmVudD4oKGRlbDogSURlbGl2ZXJ5PE9mZmVyU2V0RXZlbnQ+KTogYW55ID0+IGRlbC5ldmVudClcbiAgICAgICAgICAgIC5lYWNoKChldmVudDogT2ZmZXJTZXRFdmVudCkgPT4gY29uc29sZS5pbmZvKFwiUmVjZWl2ZWQgZXZlbnRcIiwgZXZlbnQpKVxuICAgICAgICAgICAgLmRvbmUoKCkgPT4gY29uc29sZS5sb2coXCJGaW5pc2hlZCBjb25zdW1pbmcgb24gcHJvamVjdGVkIHRvcGljLlwiKSk7XG4gICAgfSk7XG4iXX0=
